Import("fwenv")

import SCons
from fbt.appmanifest import FlipperAppType, AppManager, ApplicationsCGenerator


def LoadApplicationManifests(env):
    appmgr = env["APPMGR"] = AppManager()
    for entry in Glob("#/applications/*"):
        if isinstance(entry, SCons.Node.FS.Dir):
            appmgr.load_manifest(entry.File("application.fam").abspath, entry.name)


def DumpApplicationConfig(target, source, env):
    print(f"Loaded {len(env['APPMGR'].known_apps)} app definitions.")
    print("Firmware modules configuration:")
    for apptype in FlipperAppType:
        app_sublist = env["APPBUILD"].get_apps_of_type(apptype)
        if app_sublist:
            print(
                f"{apptype.value}:\n\t",
                ", ".join(app.appid for app in app_sublist),
            )


def PrepareApplicationsBuild(env):
    fwenv["APPBUILD"] = fwenv["APPMGR"].filter_apps(fwenv["APPS"])
    fwenv["APPBUILD_DUMP"] = Action(
        DumpApplicationConfig,
        "\tINFO\t",
    )


fwenv.AddMethod(LoadApplicationManifests)
fwenv.AddMethod(PrepareApplicationsBuild)


def build_apps_c(target, source, env):
    target_file_name = target[0].path

    gen = ApplicationsCGenerator(fwenv["APPBUILD"])
    with open(target_file_name, "w") as file:
        file.write(gen.generate())


fwenv["APPS_C_ACTION"] = Action(build_apps_c, "${APPSCOMSTR}")
